

install.packages("haven")
install.packages("R2OpenBUGS")
#DATA preparation
library(haven)
library(readxl)
data_input <- read_excel("data.xlsx", sheet = "Women")

num.LAD <- c(9,4,5,5,6,7,4,6,7,5,5,7,6,7,6,6,8,6,6,6,6,5,9,7,5,5,8,7,5,5,6,8,7,6,6,5,4,7,6,6,5,8,5,6,6,5,4,5,8,7,7,8,6,6,4,10,7,6,7,8,5,7,5,7,6,4,8,5,3,6,7,6,6,6,2,6,3,10,7,3,6,6,5,4,8,5,7,5,4,6,7,7,6,7,6,7,6,6,6,6,9,7,4,6,7,6,3,6,4,7,6,4,9,9,7,4,5,3,6,7,6,5,5,3,7,3,4,7,6,4,7,6,5,9,4,2,3,4,3,7,7,9,3,9,4,5,2,1,4,6,4,4,6,2,6,3,4,5,4,10,8,6,7,4,10,5,5,4,5,5,3,5,5,5,7,6,4,7,4,6,8,5,5,2,4,7,7,6,5,5,6,6,8,6,5,1,7,6,6,4,4,4,2,6,6,6,4,6,7,5,7,5,5,4,6,7,5,4,3,2,5,7,7,3,2,4,5,5,7,5,7,8,4,4,4,4,6,6,3,4,7,6,6,6,7,6,8,8,3,6,3,3,5,7,2,2,8,4,3,3,7,4,4,8,4,4,8,5,6,6,7,5,4,4,4,3,2,11,3,6,2,5,5,9,4,6,3,10,8,6,9,4,4,4,6,6,8,3,4,10,5,5,3,6,6,6,6)
adj.LAD <- c(2,6,7,8,11,12,18,23,24,
              1,3,6,23,
              2,4,5,6,23,
              3,5,10,21,23,
              3,4,6,9,10,38,
              1,2,3,5,7,9,33,
              1,6,8,33,
              1,7,12,13,32,33,
              5,6,33,35,36,37,38,
              4,5,21,38,39,
              1,12,16,24,25,
              1,8,11,13,14,15,16,
              8,12,14,15,32,46,
              12,13,15,46,47,48,81,
              12,13,14,16,17,81,
              11,12,15,17,24,25,
              15,16,25,27,70,72,76,81,
              1,22,23,24,26,28,
              20,22,28,31,94,95,
              19,22,23,95,98,99,
              4,10,23,39,99,106,
              18,19,20,23,28,
              1,2,3,4,18,20,21,22,99,
              1,11,16,18,25,26,27,
              11,16,17,24,27,
              18,24,27,28,29,
              17,24,25,26,28,29,30,70,
              18,19,22,26,27,29,31,
              26,27,28,30,31,
              27,29,31,70,71,
              19,28,29,30,71,94,
              8,13,33,34,45,46,49,50,
              6,7,8,9,32,34,35,
              32,33,35,43,44,45,
              9,33,34,36,42,43,
              9,35,37,42,52,
              9,36,38,52,
              5,9,10,37,39,41,52,
              10,21,38,40,41,106,
              39,41,53,59,100,106,
              38,39,40,52,53,
              35,36,43,44,51,52,58,295,
              34,35,42,44,45,
              43,42,34,58,57,45,
              32,34,43,44,50,57,
              13,14,32,47,49,
              14,46,48,49,
              14,47,49,56,81,
              32,46,47,48,50,56,68,293,
              32,45,49,57,61,67,68,
              42,52,54,58,64,65,295,
              36,37,38,41,42,51,53,54,
              40,41,52,54,59,60,
              51,52,53,60,294,295,
              56,73,76,197,
              48,49,55,67,68,76,81,155,277,293,
              44,45,50,58,61,65,307,
              42,44,51,57,65,295,
              40,53,60,100,105,110,303,
              53,54,59,63,64,184,190,294,
              50,57,62,67,307,
              61,66,67,149,150,157,307,
              60,64,165,190,296,
              51,60,63,65,294,295,296,
              51,57,58,64,296,307,
              62,67,150,155,
              50,56,61,62,66,68,155,293,
              49,50,56,67,293,
              165,163,160,
              17,27,30,71,72,78,
              30,31,70,77,78,94,291,
              17,70,73,76,78,83,
              55,72,76,83,84,197,
              75,78,83,84,197,198,
              74,197,
              17,55,56,72,73,81,
              71,78,291,
              70,71,72,74,77,82,83,198,278,291,
              80,82,85,87,92,134,289,
              79,85,289,
              48,15,14,76,17,56,
              78,79,92,134,278,291,
              78,74,72,84,73,
              73,74,83,197,
              79,80,120,130,134,140,282,289,
              92,93,108,290,292,
              79,88,89,90,92,289,290,
              87,89,91,113,290,
              87,88,90,91,
              87,89,91,117,288,289,
              88,89,90,104,113,121,288,
              79,82,86,87,290,291,292,
              86,96,108,291,292,299,
              19,31,71,95,96,291,299,
              19,20,94,96,97,98,
              93,94,95,97,108,111,299,
              95,96,98,101,102,111,
              20,95,97,99,101,102,
              20,21,23,98,101,106,
              40,59,101,105,106,110,
              97,98,99,100,102,103,106,110,301,
              97,98,101,111,113,301,302,
              101,110,300,301,
              91,112,113,114,121,300,
              59,100,109,110,114,300,303,
              21,39,40,99,100,101,
              109,114,300,
              86,93,96,111,113,290,
              105,107,114,300,
              59,100,101,103,105,300,303,
              96,97,102,108,113,302,
              104,114,115,121,
              88,91,102,104,108,111,290,300,302,
              104,105,107,109,112,115,116,182,300,
              112,114,116,121,125,185,192,
              114,115,181,185,
              90,118,287,288,289,
              288,287,117,
              122,123,125,144,145,286,
              85,135,140,144,286,288,289,
              91,104,112,115,125,288,
              119,123,125,192,286,
              119,122,124,145,146,
              123,142,146,
              115,119,121,122,192,286,288,
              128,135,280,
              131,132,134,282,
              126,133,141,142,143,144,280,
              132,133,134,141,204,205,
              85,131,140,282,
              127,130,132,140,280,281,282,
              127,129,131,133,134,280,
              128,129,132,141,280,
              79,82,85,127,129,132,205,278,282,
              120,126,140,144,
              137,141,
              136,138,141,
              137,139,141,142,
              138,142,147,
              85,120,130,131,135,280,281,
              128,129,133,136,137,138,142,
              124,128,138,139,141,143,144,146,147,
              128,142,144,
              119,120,128,135,142,143,145,146,286,
              119,123,144,146,
              123,124,142,144,145,
              139,142,
              149,
              150,62,298,148,
              62,66,149,155,297,298,
              157,165,168,296,
              154,156,158,297,
              155,158,199,200,207,297,
              152,297,
              56,66,67,150,153,297,
              152,158,200,
              62,151,297,307,
              152,153,156,200,297,
              160,164,284,285,
              69,159,163,164,165,166,168,169,170,284,
              169,170,171,172,173,174,175,176,
              176,178,208,210,283,284,
              69,160,165,166,167,283,284,
              159,160,166,285,
              63,69,151,160,163,167,168,186,190,296,
              160,163,164,284,285,
              163,165,178,186,283,
              151,160,165,169,
              160,161,168,170,171,
              160,161,169,176,284,
              161,169,172,
              161,171,173,224,231,
              161,172,174,223,231,
              161,173,175,223,254,
              161,174,176,209,210,245,254,
              161,162,170,175,210,284,
              178,191,208,211,
              162,167,177,186,191,208,283,
              181,183,187,193,
              181,183,192,193,263,271,
              116,179,180,182,183,185,187,192,
              114,181,184,187,189,
              179,180,181,187,193,
              60,182,
              115,116,181,192,
              165,167,178,188,189,190,191,
              179,181,182,183,188,189,193,
              186,187,189,191,193,194,
              182,186,187,188,190,
              60,63,165,186,189,
              177,178,186,188,194,211,
              115,122,125,180,181,185,
              179,180,183,187,188,194,271,272,
              188,191,193,211,215,272,
              205,278,279,304,305,
              305,
              55,73,74,75,84,198,277,
              74,78,197,199,278,305,
              153,198,201,206,207,278,
              153,156,158,207,
              199,202,206,207,
              201,203,204,206,
              202,204,
              129,202,203,205,206,304,
              129,134,195,204,278,304,
              199,201,202,204,278,304,
              153,199,200,201,
              162,177,178,210,211,276,
              175,210,212,243,244,245,306,
              162,175,176,208,209,
              177,191,194,208,214,215,276,
              209,216,243,257,306,
              216,217,218,219,257,
              211,215,267,306,
              194,211,214,264,267,272,
              212,213,217,257,267,275,306,
              213,216,219,268,275,
              213,219,251,257,
              213,217,218,
              222,221,
              220,222,227,230,232,
              220,221,226,230,231,232,233,
              173,174,231,232,233,234,254,
              172,226,231,
              228,236,
              222,224,230,231,
              221,228,230,232,237,
              225,227,230,236,237,
              232,234,235,237,246,253,254,
              221,222,226,227,228,
              172,173,222,223,224,226,233,
              221,222,223,227,229,233,234,237,
              223,232,231,222,
              223,229,232,254,
              229,236,237,253,
              225,228,235,237,
              227,228,229,232,235,236,
              239,240,241,244,245,247,
              238,241,244,
              238,241,242,247,
              238,239,240,242,243,244,247,
              240,241,243,247,250,257,
              209,212,241,242,244,257,
              209,238,239,241,243,245,
              175,209,238,244,246,247,254,
              229,245,247,248,253,254,
              238,240,241,242,245,246,248,250,
              246,247,249,250,252,253,255,256,
              248,250,252,
              242,247,248,249,251,257,
              218,250,257,
              248,249,256,
              229,235,246,248,255,
              174,175,223,229,234,245,246,
              248,253,
              248,252,
              212,213,216,218,242,243,250,251,
              259,260,261,270,
              258,260,261,
              261,259,258,
              258,259,260,262,266,269,270,
              266,261,263,270,
              180,262,270,271,
              215,265,267,269,271,272,273,274,
              264,266,269,274,
              261,262,265,269,
              214,215,216,264,268,273,275,306,
              217,267,273,274,275,
              261,264,265,266,270,271,
              258,261,262,263,269,271,
              180,193,263,264,269,270,272,
              193,194,215,264,271,
              264,267,268,274,
              264,265,268,273,
              216,217,267,268,
              208,211,306,
              56,197,
              78,82,134,195,198,199,205,206,279,304,305,
              278,195,305,
              126,128,131,132,133,140,
              140,131,
              85,127,130,131,134,
              162,163,167,178,284,
              159,160,162,163,166,170,176,283,285,
              284,166,164,159,
              119,120,122,125,144,288,
              117,118,288,
              90,91,117,118,120,121,125,286,287,289,
              79,80,85,87,90,117,120,288,
              86,87,88,92,108,113,
              71,77,78,82,92,93,94,292,299,
              86,92,93,291,
              56,49,68,67,
              54,60,64,295,
              294,64,54,42,58,51,
              63,64,65,151,165,307,
              150,152,153,154,155,157,158,298,
              149,150,297,
              291,93,96,94,
              103,104,105,107,109,110,113,114,301,302,
              101,102,103,300,302,
              113,300,301,111,102,
              59,105,110,
              195,204,205,206,278,305,
              195,196,198,278,279,304,
              209,212,214,216,267,276,
              57,61,62,65,157,296)
weights.LAD <- rep(1,each=1700)

#AMI events and popluation
Events.65.p8 <- as.vector(data_input$age_65_p8) 
population.65.p8 <- as.vector(data_input$pop_65_p8)


LAD <- as.vector(data_input$LAD)

##data preparation
data <- list(Events.65.p8= Events.65.p8, population.65.p8 = population.65.p8,
             num = num.LAD, adj = adj.LAD, weights = weights.LAD, N=307)

##set inits
inits <- list (
  list(tau.b.65.p8 = 0.5, tau.h.65.p8 = 0.2, alpha.65.p8=0),
  list(tau.b.65.p8 = 1.0, tau.h.65.p8 = 1.0, alpha.65.p8=1.0))


##set outputs
parameters <- c("esimate.65.p8")


##bugs

library("R2OpenBUGS")
sim <- bugs(data, inits, parameters, model.file = "CoalBan_model.txt",
            n.chains = 2,  n.iter = 15000, n.thin = 100, n.burnin=12000, codaPkg = FALSE, debug= TRUE,DIC=TRUE, bugs.seed=8)

##log file
tempdir()  
save(sim,file="AMI_results.Rdata")


